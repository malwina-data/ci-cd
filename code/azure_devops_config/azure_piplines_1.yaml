# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- main

pool:
  name: 'Default'
  demands:
    - agent.name -equals AgentSelfHosted 

steps:
  - script: |
      echo "Updating package list"
      sudo apt update
    displayName: Update apt
    continueOnError: false

  - script: |
      sudo apt update
      sudo apt install -y software-properties-common
      sudo add-apt-repository -y ppa:deadsnakes/ppa
      sudo apt update
      sudo apt install -y python3.10 python3.10-venv python3.10-dev
    displayName: Install Python 3.10

  - script: |
      echo "Checking Python version"
      python3.10 --version
    displayName: Check Python Version

  - script: |
      sudo apt install -y python3.10 python3.10-venv python3.10-dev
    displayName: Save Log to File
    
  - script: |
      sudo apt update
      sudo apt install -y python3-venv python3-pip
      python3 -m venv myenv
      source myenv/bin/activate

      pip install -r requirements.txt
      pip install flask
      pip install pytest 
      
      pytest --junitxml=results.xml
    displayName: Check pytest version

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/results.xml'
      testResultsFormat: 'JUnit'
  
  - script: |
      echo "Listing files"
      ls $(System.DefaultWorkingDirectory)
    displayName: 'List files in working directory'

  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'AWS-EC2-Production'
      sourceFolder: '$(System.DefaultWorkingDirectory)/code'
      contents: '**/*'
      targetFolder: '/home/ubuntu/app'

  - task: SSH@0
    inputs:
      sshEndpoint: 'AWS-EC2-Production'  # Połączenie SSH z serwerem
      scriptPath: './backup.sh'
    displayName: 'Wykonanie backupu aplikacji'

  - task: SSH@0
    inputs:
      sshEndpoint: 'AWS-EC2-Production'  # Połączenie SSH z serwerem
      scriptPath: './python main.py'
    displayName: 'start aplikacji'

